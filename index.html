<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Braze Bulletin</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            line-height: 1.6;
            color: #1a1a1a;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            margin: 0;
            padding: 0;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: transparent;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 1.5rem 0;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 1px solid rgba(128, 30, 215, 0.1);
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 2rem;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, #801ed7 0%, #6b1bb3 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
            letter-spacing: -0.02em;
        }

        .header p {
            color: #64748b;
            font-size: 1.1rem;
            font-weight: 400;
        }

        .main-content {
            padding: 3rem 2rem;
        }

        .section {
            margin-bottom: 4rem;
            background: transparent;
        }

        .section h2 {
            color: #1e293b;
            margin-bottom: 2.5rem;
            font-size: 2.25rem;
            font-weight: 700;
            letter-spacing: -0.02em;
        }

        .search-container {
            max-width: 600px;
            margin: 0 auto 2rem;
        }

        .input-group {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            align-items: center;
        }

        .input-group input {
            flex: 1;
            padding: 1rem 1.25rem;
            border: 2px solid #e2e8f0;
            border-radius: 16px;
            font-size: 1rem;
            outline: none;
            transition: all 0.3s ease;
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.04);
        }

        .input-group input:focus {
            border-color: #801ed7;
            box-shadow: 0 0 0 4px rgba(128, 30, 215, 0.1), 0 4px 12px rgba(0,0,0,0.08);
            transform: translateY(-1px);
        }

        .input-group input::placeholder {
            color: #94a3b8;
            font-weight: 400;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 25px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #801ed7 0%, #6b1bb3 100%);
            color: white;
            border-radius: 16px;
            padding: 1rem 2rem;
            white-space: nowrap;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(128, 30, 215, 0.3);
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #6b1bb3 0%, #5a1a9e 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(128, 30, 215, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .news-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 2rem;
        }

        .news-item {
            background: white;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 8px 25px rgba(0,0,0,0.08);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            border: 1px solid rgba(255, 255, 255, 0.8);
        }

        .news-item:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 20px 40px rgba(0,0,0,0.12);
        }

        .news-item.selected {
            border: 2px solid #801ed7;
            box-shadow: 0 8px 25px rgba(128, 30, 215, 0.2);
        }

        .news-checkbox {
            position: absolute;
            top: 1rem;
            right: 1rem;
            z-index: 10;
            transform: scale(1.2);
            background: white;
            border-radius: 4px;
            padding: 0.25rem;
        }

        .card-image {
            height: 200px;
            background: linear-gradient(135deg, #801ed7 0%, #6b1bb3 50%, #5a1a9e 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 2rem;
            font-weight: 700;
            text-align: center;
            padding: 1rem;
            position: relative;
            overflow: hidden;
        }

        .card-image::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, rgba(255,255,255,0.1) 0%, transparent 100%);
            pointer-events: none;
        }

        .card-content {
            padding: 2rem;
        }

        .card-meta {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
            font-size: 0.85rem;
            color: #64748b;
            font-weight: 500;
        }

        .source-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: linear-gradient(135deg, #801ed7 0%, #6b1bb3 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .news-title {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 0.75rem;
            line-height: 1.3;
            color: #1e293b;
            letter-spacing: -0.01em;
        }

        .news-description {
            font-size: 0.95rem;
            color: #64748b;
            line-height: 1.6;
            margin-bottom: 1.5rem;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .news-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.85rem;
            color: #64748b;
        }

        .tag {
            color: #801ed7;
            font-weight: 600;
            background: rgba(128, 30, 215, 0.1);
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.8rem;
        }

        .summary-item {
            background: white;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 20px;
            border-left: 4px solid #28a745;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .summary-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .summary-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #495057;
        }

        .summary-content {
            color: #6c757d;
            line-height: 1.7;
            margin-bottom: 15px;
        }

        .summary-meta {
            font-size: 0.9rem;
            color: #6c757d;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .feed-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .search-box {
            flex: 1;
            min-width: 200px;
        }

        .hidden {
            display: none;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            border: 1px solid #f5c6cb;
        }

        .success {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            border: 1px solid #c3e6cb;
        }

        @media (max-width: 768px) {
            .header-content {
                padding: 0 1rem;
            }
            
            .main-content {
                padding: 1rem;
            }
            
            .search-container {
                margin: 0 1rem 2rem;
                max-width: none;
            }
            
            .input-group {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .news-grid {
                grid-template-columns: 1fr;
            }
            
            .feed-controls {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-content">
                <h1>📰 Braze Bulletin</h1>
                <p>Search news, generate summaries, and export to Slack</p>
            </div>
        </div>

        <div class="main-content">
            <!-- Search Section -->
            <div class="section">
                <div class="search-container">
                    <div class="input-group">
                        <input type="text" id="clientInput" placeholder="Enter company name..." />
                        <button class="btn btn-primary" onclick="searchNews()">Search</button>
                    </div>
                    <div style="text-align: center; font-size: 0.95rem; color: #64748b; margin-bottom: 1.5rem; padding: 1rem; background: rgba(255, 255, 255, 0.6); border-radius: 12px; border: 1px solid rgba(128, 30, 215, 0.1);">
                        💡 <strong>Tip:</strong> Enter company names like "Apple", "Microsoft", "Tesla" to search for marketing-related news articles from the last 7 days
                    </div>
                    <div style="text-align: center;">
                        <button class="btn btn-secondary" onclick="testNewsAPI()" style="font-size: 0.8rem; padding: 8px 16px;">
                            🧪 Test News API (Apple)
                        </button>
                    </div>
                </div>
                <div class="loading" id="searchLoading">
                    <div class="spinner"></div>
                    <p>Searching for news...</p>
                </div>
                <div id="searchError" class="error hidden"></div>
            </div>

            <!-- News Results Section -->
            <div class="section" id="newsSection" style="display: none;">
                <h2>📰 Marketing News Results</h2>
                <div style="display: flex; gap: 15px; margin-bottom: 20px; align-items: center; flex-wrap: wrap;">
                    <button class="btn btn-secondary" onclick="selectAllNews()">Select All</button>
                    <button class="btn btn-secondary" onclick="deselectAllNews()">Deselect All</button>
                    <button class="btn btn-warning" onclick="previewMetadata()" id="previewBtn" disabled>
                        Preview Metadata (<span id="selectedCount">0</span>)
                    </button>
                    <button class="btn btn-success" onclick="sendMetadata()" id="sendBtn" disabled>
                        Send to 3rd Party (<span id="selectedCount2">0</span>)
                    </button>
                </div>
                <div class="news-grid" id="newsResults"></div>
                <div class="loading" id="metadataLoading">
                    <div class="spinner"></div>
                    <p>Sending metadata...</p>
                </div>
            </div>

            <!-- Metadata Preview Section -->
            <div class="section" id="metadataSection" style="display: none;">
                <h2>👁️ Metadata Preview</h2>
                <div class="feed-controls">
                    <button class="btn btn-success" onclick="sendMetadata()" id="sendFromPreviewBtn">
                        Send to 3rd Party (<span id="previewSelectedCount">0</span>)
                    </button>
                    <button class="btn btn-secondary" onclick="closePreview()">Close Preview</button>
                </div>
                <div id="metadataPreview"></div>
            </div>

            <!-- Sent Articles Feed Section -->
            <div class="section" id="feedSection" style="display: none;">
                <h2>📋 Sent Articles Feed</h2>
                <div class="feed-controls">
                    <input type="text" class="search-box" id="feedSearch" placeholder="Search sent articles..." onkeyup="filterFeed()" />
                    <button class="btn btn-warning" onclick="exportAllToSlack()">Export All to Slack</button>
                </div>
                <div id="feedResults"></div>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let currentNews = [];
        let currentMetadata = [];
        let allSentArticles = [];

        // Configuration - Replace with your actual API endpoints and keys
        const CONFIG = {
            NEWS_API_KEY: '59f4045772a24acead4c904a98c331fc', // News API key
            NEWS_API_URL: 'https://newsapi.org/v2/everything',
            THIRD_PARTY_API_URL: '/api/tray', // Tray endpoint via Vercel proxy
            SLACK_WEBHOOK_URL: 'YOUR_SLACK_WEBHOOK_URL' // Replace with actual Slack webhook URL
        };

        // Test function to quickly test News API
        async function testNewsAPI() {
            console.log('🧪 Testing News API with Apple marketing news...');
            document.getElementById('clientInput').value = 'Apple';
            await searchNews();
        }

        // Search for news articles
        async function searchNews() {
            const clientName = document.getElementById('clientInput').value.trim();
            if (!clientName) {
                showError('searchError', 'Please enter a client name');
                return;
            }

            showLoading('searchLoading');
            hideError('searchError');

            try {
                // Try real News API first, fallback to mock if not configured
                let response;
                console.log('🔧 CONFIG.NEWS_API_KEY:', CONFIG.NEWS_API_KEY);
                console.log('🔧 API key check:', CONFIG.NEWS_API_KEY && CONFIG.NEWS_API_KEY !== 'YOUR_NEWS_API_KEY');
                
                if (CONFIG.NEWS_API_KEY && CONFIG.NEWS_API_KEY !== 'YOUR_NEWS_API_KEY') {
                    console.log('🚀 Using REAL News API');
                    response = await searchNewsAPI(clientName);
                } else {
                    console.log('🎭 Using MOCK News API');
                    response = await mockNewsSearch(clientName);
                }
                
                console.log('📊 Response received:', response);
                currentNews = response.articles;
                console.log('📰 Current news set:', currentNews);
                
                displayNewsResults();
                showSection('newsSection');
            } catch (error) {
                console.error('❌ Search error:', error);
                showError('searchError', 'Failed to search news: ' + error.message);
            } finally {
                hideLoading('searchLoading');
            }
        }

        // Real news search function using News API via proxy
        async function searchNewsAPI(query) {
            try {
                console.log('🔍 Starting News API search for:', query);
                
                // Get articles from the last 7 days
                const fromDate = new Date();
                fromDate.setDate(fromDate.getDate() - 7);
                const fromDateStr = fromDate.toISOString().split('T')[0];
                
                console.log('📅 Searching from date:', fromDateStr);
                
                // Build search query - focus on marketing news for the company
                const searchQuery = `(${query} OR "${query}") AND (marketing OR "customer engagement" OR "brand" OR "advertising" OR "campaign" OR "digital marketing" OR "social media" OR "content marketing" OR "email marketing" OR "growth" OR "revenue" OR "sales")`;
                console.log('🔎 Marketing-focused search query:', searchQuery);
                
                // Use our Vercel proxy instead of direct News API call
                const proxyUrl = `/api/news?` +
                    `q=${encodeURIComponent(searchQuery)}&` +
                    `from=${fromDateStr}&` +
                    `sortBy=relevancy&` +
                    `pageSize=5&` +
                    `language=en`;
                
                console.log('🌐 Proxy URL:', proxyUrl);
                
                const response = await fetch(proxyUrl);
                
                console.log('📡 Response status:', response.status, response.statusText);
                
                if (!response.ok) {
                    // Read the response body only once
                    const responseText = await response.text();
                    console.error('❌ Error Response Text:', responseText);
                    
                    // Try to parse as JSON, fallback to text if it fails
                    let errorData;
                    try {
                        errorData = JSON.parse(responseText);
                        console.error('❌ Parsed Error Response:', errorData);
                        throw new Error(`News API error: ${response.status} ${response.statusText} - ${errorData.error || 'Unknown error'}`);
                    } catch (jsonError) {
                        // If response is not JSON (e.g., HTML error page)
                        console.error('❌ Non-JSON Error Response:', responseText);
                        throw new Error(`News API returned non-JSON response: ${response.status} ${response.statusText}. This usually indicates an API key issue or rate limiting.`);
                    }
                }
                
                const data = await response.json();
                console.log('📊 API Response:', data);
                
                if (data.status !== 'ok') {
                    console.error('❌ API returned error status:', data);
                    throw new Error(`News API returned error: ${data.message || 'Unknown error'}`);
                }
                
                console.log('📰 Total articles found:', data.totalResults);
                console.log('📰 Articles in response:', data.articles?.length || 0);
                
                // Filter and format the results
                const articles = data.articles
                    .filter(article => {
                        const hasRequiredFields = article.title && 
                            article.description && 
                            article.url && 
                            article.publishedAt &&
                            article.source?.name;
                        console.log('✅ Article valid:', hasRequiredFields, article.title);
                        return hasRequiredFields;
                    })
                    .slice(0, 5) // Take top 5 marketing articles
                    .map(article => {
                        const formattedArticle = {
                            title: article.title,
                            description: article.description,
                            url: article.url,
                            publishedAt: article.publishedAt,
                            source: { name: article.source.name }
                        };
                        console.log('📝 Formatted article:', formattedArticle);
                        return formattedArticle;
                    });
                
                console.log('🎯 Final articles to return:', articles.length);
                return { articles };
                
            } catch (error) {
                console.error('❌ News API Error:', error);
                throw new Error(`Failed to fetch news: ${error.message}`);
            }
        }

        // Fallback mock function for when News API is not configured
        async function mockNewsSearch(query) {
            // Simulate API delay
            await new Promise(resolve => setTimeout(resolve, 1500));
            
            // Generate dates for the last 7 days
            const now = new Date();
            const dates = [];
            for (let i = 0; i < 7; i++) {
                const date = new Date(now);
                date.setDate(date.getDate() - i);
                dates.push(date.toISOString());
            }
            
            return {
                articles: [
                    {
                        title: `${query} launches revolutionary AI-powered customer engagement platform with real-time personalization`,
                        description: `The company unveiled its next-generation customer engagement suite featuring advanced AI algorithms that deliver personalized experiences at scale. The platform integrates machine learning with behavioral analytics to predict customer needs and optimize engagement strategies across all touchpoints.`,
                        url: 'https://example.com/news1',
                        publishedAt: dates[0], // Today
                        source: { name: 'TechCrunch' }
                    },
                    {
                        title: `${query} reports 45% revenue growth in Q4 2023, driven by enterprise AI adoption`,
                        description: `Strong quarterly performance highlights the company's successful pivot to AI-driven solutions. Enterprise customers are increasingly adopting their platform for customer engagement, with average deal sizes increasing by 60% year-over-year. The company also announced expansion into European markets.`,
                        url: 'https://example.com/news2',
                        publishedAt: dates[1], // Yesterday
                        source: { name: 'Business Wire' }
                    },
                    {
                        title: `${query} secures $50M Series C funding to accelerate AI innovation and global expansion`,
                        description: `The funding round, led by prominent venture capital firms, will fuel research and development in artificial intelligence, machine learning, and customer engagement technologies. The company plans to double its engineering team and expand into Asia-Pacific markets.`,
                        url: 'https://example.com/news3',
                        publishedAt: dates[2], // 2 days ago
                        source: { name: 'VentureBeat' }
                    },
                    {
                        title: `${query} announces strategic partnership with Microsoft Azure for enhanced cloud scalability`,
                        description: `The partnership will provide customers with improved performance, global reach, and enterprise-grade security. The integration allows seamless deployment of customer engagement solutions on Azure infrastructure, with built-in compliance and data residency options.`,
                        url: 'https://example.com/news4',
                        publishedAt: dates[3], // 3 days ago
                        source: { name: 'PR Newswire' }
                    },
                    {
                        title: `${query} recognized as "Best Customer Engagement Platform" at 2024 MarTech Awards`,
                        description: `The company received industry recognition for its innovative approach to customer engagement and AI-driven personalization. The award highlights their commitment to helping businesses build meaningful relationships with customers through technology.`,
                        url: 'https://example.com/news5',
                        publishedAt: dates[4], // 4 days ago
                        source: { name: 'MarTech Today' }
                    }
                ]
            };
        }

        // Display news results
        function displayNewsResults() {
            const container = document.getElementById('newsResults');
            container.innerHTML = '';

            currentNews.forEach((article, index) => {
                const articleDiv = document.createElement('div');
                articleDiv.className = 'news-item';
                
                // Create a simple icon/logo from the first letter of the source
                const sourceInitial = article.source.name.charAt(0).toUpperCase();
                
                articleDiv.innerHTML = `
                    <input type="checkbox" class="news-checkbox" onchange="updateSelectedCount()" data-index="${index}">
                    <div class="card-image">
                        ${sourceInitial}
                    </div>
                    <div class="card-content">
                        <div class="card-meta">
                            <div class="source-icon"></div>
                            <span>${article.source.name}</span>
                            <span>•</span>
                            <span>${new Date(article.publishedAt).toLocaleDateString()}</span>
                        </div>
                        <h3 class="news-title">${article.title}</h3>
                        <p class="news-description">${article.description}</p>
                        <div class="news-meta">
                            <span class="tag">Marketing</span>
                            <span>5 min read</span>
                        </div>
                    </div>
                `;
                container.appendChild(articleDiv);
            });
        }

        // Update selected count
        function updateSelectedCount() {
            const checkboxes = document.querySelectorAll('.news-checkbox:checked');
            const count = checkboxes.length;
            document.getElementById('selectedCount').textContent = count;
            document.getElementById('selectedCount2').textContent = count;
            document.getElementById('previewBtn').disabled = count === 0;
            document.getElementById('sendBtn').disabled = count === 0;
        }

        // Select all news items
        function selectAllNews() {
            document.querySelectorAll('.news-checkbox').forEach(checkbox => {
                checkbox.checked = true;
            });
            updateSelectedCount();
        }

        // Deselect all news items
        function deselectAllNews() {
            document.querySelectorAll('.news-checkbox').forEach(checkbox => {
                checkbox.checked = false;
            });
            updateSelectedCount();
        }

        // Preview metadata for selected articles
        function previewMetadata() {
            const selectedCheckboxes = document.querySelectorAll('.news-checkbox:checked');
            const selectedArticles = Array.from(selectedCheckboxes).map(cb => 
                currentNews[parseInt(cb.dataset.index)]
            );

            if (selectedArticles.length === 0) {
                showError('searchError', 'Please select at least one article');
                return;
            }

            // Generate metadata for selected articles
            currentMetadata = selectedArticles.map(article => ({
                id: Date.now() + Math.random(),
                title: article.title,
                date: new Date(article.publishedAt).toLocaleDateString(),
                url: article.url,
                website: article.source.name,
                publishedAt: article.publishedAt,
                description: article.description
            }));

            displayMetadataPreview();
            showSection('metadataSection');
        }

        // Send metadata to 3rd party API
        async function sendMetadata() {
            const selectedCheckboxes = document.querySelectorAll('.news-checkbox:checked');
            const selectedArticles = Array.from(selectedCheckboxes).map(cb => 
                currentNews[parseInt(cb.dataset.index)]
            );

            if (selectedArticles.length === 0) {
                showError('searchError', 'Please select at least one article');
                return;
            }

            showLoading('metadataLoading');

            try {
                // Get the account name from the search input
                const accountName = document.getElementById('clientInput').value.trim() || 'Unknown Company';
                
                // Generate metadata in the required format
                const metadata = selectedArticles.map(article => ({
                    "Account Name": accountName,
                    "Article Title": article.title,
                    "Article Summary": article.description,
                    "Article Date": new Date(article.publishedAt).toLocaleDateString('en-US', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    }),
                    "URL": article.url,
                    "Destination": "Both"
                }));

                // Send all articles as a single array in one POST request
                await sendToTrayAPI(metadata);
                
                // Add to sent articles feed
                const sentArticles = selectedArticles.map((article, index) => ({
                    title: article.title,
                    date: new Date(article.publishedAt).toLocaleDateString(),
                    url: article.url,
                    website: article.source.name,
                    publishedAt: article.publishedAt,
                    description: article.description,
                    accountName: accountName,
                    id: Date.now() + Math.random() + index,
                    sentAt: new Date().toISOString()
                }));
                
                allSentArticles = [...allSentArticles, ...sentArticles];
                updateFeed();
                showSection('feedSection');
                
                showSuccess(`Successfully sent ${metadata.length} article(s) to 3rd party service!`);
            } catch (error) {
                showError('searchError', 'Failed to send metadata: ' + error.message);
            } finally {
                hideLoading('metadataLoading');
            }
        }

        // Send to Tray API endpoint
        async function sendToTrayAPI(articlesArray) {
            // Log the exact format being sent
            console.log('Sending POST request to Tray API with data:', JSON.stringify(articlesArray, null, 2));
            console.log('Using API URL:', CONFIG.THIRD_PARTY_API_URL);
            
            try {
                // Send actual POST request to Tray endpoint
                const apiUrl = CONFIG.THIRD_PARTY_API_URL + '?t=' + Date.now(); // Cache busting
                console.log('Final API URL with cache busting:', apiUrl);
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(articlesArray)
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Tray API error:', response.status, errorText);
                    throw new Error(`Tray API error: ${response.status} ${response.statusText} - ${errorText}`);
                }
                
                const result = await response.json();
                console.log('Tray API response:', result);
                return result;
                
            } catch (error) {
                console.error('Failed to send to Tray API:', error);
                throw error;
            }
        }

        // Display metadata preview
        function displayMetadataPreview() {
            const container = document.getElementById('metadataPreview');
            container.innerHTML = '';

            const accountName = document.getElementById('clientInput').value.trim() || 'Unknown Company';

            currentMetadata.forEach(metadata => {
                const formattedDate = new Date(metadata.publishedAt).toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });

                const metadataDiv = document.createElement('div');
                metadataDiv.className = 'summary-item';
                metadataDiv.innerHTML = `
                    <div class="summary-header">
                        <div class="summary-title">${metadata.title}</div>
                    </div>
                    <div class="summary-content">
                        <div style="margin-bottom: 15px; padding: 15px; background: #f8fafc; border-radius: 8px; border-left: 4px solid #801ed7;">
                            <h4 style="margin-bottom: 10px; color: #1e293b;">JSON Format to be sent:</h4>
                            <pre style="background: #1e293b; color: #e2e8f0; padding: 15px; border-radius: 6px; font-size: 0.85rem; overflow-x: auto; margin: 0;">{
  "Account Name": "${accountName}",
  "Article Title": "${metadata.title}",
  "Article Summary": "${metadata.description}",
  "Article Date": "${formattedDate}",
  "URL": "${metadata.url}",
  "Slack Message": "Slack"
}</pre>
                        </div>
                        <div style="margin-bottom: 10px;"><strong>Source:</strong> ${metadata.website}</div>
                        <div style="margin-bottom: 10px;"><strong>URL:</strong> <a href="${metadata.url}" target="_blank" style="color: #801ed7;">${metadata.url}</a></div>
                    </div>
                    <div class="summary-meta">
                        <span>Ready to send as POST request</span>
                    </div>
                `;
                container.appendChild(metadataDiv);
            });
        }

        // Update feed view
        function updateFeed() {
            const container = document.getElementById('feedResults');
            container.innerHTML = '';

            allSentArticles.forEach(article => {
                const articleDiv = document.createElement('div');
                articleDiv.className = 'summary-item';
                articleDiv.innerHTML = `
                    <div class="summary-header">
                        <div class="summary-title">${article.title}</div>
                        <button class="btn btn-warning" onclick="exportToSlack(${article.id})">Export to Slack</button>
                    </div>
                    <div class="summary-content">
                        <div style="margin-bottom: 10px;"><strong>Date:</strong> ${article.date}</div>
                        <div style="margin-bottom: 10px;"><strong>Website:</strong> ${article.website}</div>
                        <div style="margin-bottom: 10px;"><strong>URL:</strong> <a href="${article.url}" target="_blank" style="color: #667eea;">${article.url}</a></div>
                        <div style="margin-bottom: 10px;"><strong>Description:</strong> ${article.description}</div>
                    </div>
                    <div class="summary-meta">
                        <span>Sent: ${new Date(article.sentAt).toLocaleString()}</span>
                    </div>
                `;
                container.appendChild(articleDiv);
            });
        }

        // Export individual article to Slack
        async function exportToSlack(articleId) {
            const article = allSentArticles.find(a => a.id === articleId);
            if (!article) return;

            try {
                // Simulate Slack export - replace with actual webhook call
                await mockSlackExport(article);
                showSuccess(`Article exported to Slack successfully!`);
            } catch (error) {
                showError('searchError', 'Failed to export to Slack: ' + error.message);
            }
        }

        // Export all articles to Slack
        async function exportAllToSlack() {
            if (allSentArticles.length === 0) {
                showError('searchError', 'No articles to export');
                return;
            }

            try {
                // Simulate bulk Slack export - replace with actual webhook call
                await mockBulkSlackExport(allSentArticles);
                showSuccess(`All ${allSentArticles.length} articles exported to Slack successfully!`);
            } catch (error) {
                showError('searchError', 'Failed to export to Slack: ' + error.message);
            }
        }

        // Close metadata preview
        function closePreview() {
            document.getElementById('metadataSection').style.display = 'none';
        }

        // Mock Slack export - replace with actual webhook integration
        async function mockSlackExport(article) {
            await new Promise(resolve => setTimeout(resolve, 1000));
            console.log('Exporting to Slack:', article);
        }

        // Mock bulk Slack export - replace with actual webhook integration
        async function mockBulkSlackExport(articles) {
            await new Promise(resolve => setTimeout(resolve, 1500));
            console.log('Bulk exporting to Slack:', articles);
        }

        // Filter feed
        function filterFeed() {
            const searchTerm = document.getElementById('feedSearch').value.toLowerCase();
            const items = document.querySelectorAll('#feedResults .summary-item');
            
            items.forEach(item => {
                const title = item.querySelector('.summary-title').textContent.toLowerCase();
                const content = item.querySelector('.summary-content').textContent.toLowerCase();
                const matches = title.includes(searchTerm) || content.includes(searchTerm);
                item.style.display = matches ? 'block' : 'none';
            });
        }

        // Utility functions
        function showLoading(elementId) {
            document.getElementById(elementId).style.display = 'block';
        }

        function hideLoading(elementId) {
            document.getElementById(elementId).style.display = 'none';
        }

        function showError(elementId, message) {
            const errorDiv = document.getElementById(elementId);
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
        }

        function hideError(elementId) {
            document.getElementById(elementId).classList.add('hidden');
        }

        function showSuccess(message) {
            // Create temporary success message
            const successDiv = document.createElement('div');
            successDiv.className = 'success';
            successDiv.textContent = message;
            document.querySelector('.main-content').insertBefore(successDiv, document.querySelector('.section'));
            
            setTimeout(() => {
                successDiv.remove();
            }, 3000);
        }

        function showSection(sectionId) {
            document.getElementById(sectionId).style.display = 'block';
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            // Add enter key support for search
            document.getElementById('clientInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchNews();
                }
            });
        });
    </script>
</body>
</html>
